# ğŸ” Auth Flow - Luá»“ng Authentication khi Reload

## ğŸ“Š SÆ¡ Ä‘á»“ luá»“ng hoÃ n chá»‰nh

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. USER LOGIN                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  useLogin.ts: authApi.login()                 â”‚
    â”‚  â”œâ”€ Gá»i POST /api/auth/login                  â”‚
    â”‚  â”œâ”€ Nháº­n: { user, token, refreshToken }       â”‚
    â”‚  â””â”€ Response tá»« backend                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ’¾ LÆ¯U VÃ€O 3 NÆ I:                            â”‚
    â”‚  â”œâ”€ localStorage.setItem('accessToken', ...)  â”‚
    â”‚  â”œâ”€ localStorage.setItem('refreshToken', ...) â”‚
    â”‚  â””â”€ document.cookie = 'accessToken=...'       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ”„ Redux Store Update                        â”‚
    â”‚  dispatch(setCredentials({                    â”‚
    â”‚    user: { id, email, fullname, avatarUrl },  â”‚
    â”‚    accessToken                                â”‚
    â”‚  }))                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âœ… State hiá»‡n táº¡i:                           â”‚
    â”‚  â€¢ Redux: isAuthenticated = true              â”‚
    â”‚  â€¢ localStorage: cÃ³ accessToken               â”‚
    â”‚  â€¢ Cookie: cÃ³ accessToken (cho middleware)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2. USER RELOAD PAGE ğŸ”„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âš ï¸ PROBLEM: Redux store bá»‹ reset!            â”‚
    â”‚  â€¢ Redux: isAuthenticated = false             â”‚
    â”‚  â€¢ localStorage: VáºªN CÃ’N accessToken âœ“        â”‚
    â”‚  â€¢ Cookie: VáºªN CÃ’N accessToken âœ“              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸš€ SOLUTION: AuthInitializer Component       â”‚
    â”‚  (Cháº¡y ngay khi app khá»Ÿi Ä‘á»™ng)                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1ï¸âƒ£ Äá»c token tá»« localStorage                 â”‚
    â”‚     const token = localStorage.getItem(...)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  2ï¸âƒ£ Verify token + Láº¥y user info              â”‚
    â”‚     GET /api/auth/me                          â”‚
    â”‚     Headers: { Authorization: Bearer token }  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
            Token há»£p lá»‡           Token khÃ´ng há»£p lá»‡
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âœ… Backend returns  â”‚   â”‚  âŒ 401 Unauthorized â”‚
    â”‚  { id, email, ... } â”‚   â”‚                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  3ï¸âƒ£ Restore Redux    â”‚   â”‚  ğŸ§¹ Clean up:       â”‚
    â”‚  dispatch(           â”‚   â”‚  â€¢ Clear localStorageâ”‚
    â”‚    setCredentials()  â”‚   â”‚  â€¢ Clear cookie     â”‚
    â”‚  )                   â”‚   â”‚  â€¢ User redirected  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âœ… State sau khi restore:                    â”‚
    â”‚  â€¢ Redux: isAuthenticated = true              â”‚
    â”‚  â€¢ Redux: user = { id, email, ... }           â”‚
    â”‚  â€¢ localStorage: accessToken âœ“                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3. API CALLS (Authenticated)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ“¤ Request Interceptor (api.ts)              â”‚
    â”‚  const token = localStorage.getItem(...)      â”‚
    â”‚  config.headers.Authorization = `Bearer ...`  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸŒ API Call                                  â”‚
    â”‚  GET /api/audios                              â”‚
    â”‚  Headers: Authorization: Bearer xxx...        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
            Success                  401 Error
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  âœ… Data returned    â”‚   â”‚  âŒ Response         â”‚
    â”‚                     â”‚   â”‚  Interceptor:       â”‚
    â”‚                     â”‚   â”‚  â€¢ Clear storage    â”‚
    â”‚                     â”‚   â”‚  â€¢ Maybe redirect   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ CÃ¡c Component chÃ­nh

### 1. **AuthInitializer** (NEW âœ¨)
- **Location**: `src/components/provider/AuthInitializer.tsx`
- **Má»¥c Ä‘Ã­ch**: Restore auth state tá»« localStorage khi reload
- **Khi nÃ o cháº¡y**: Ngay khi app khá»Ÿi Ä‘á»™ng (trong root layout)
- **Logic**:
  1. Check localStorage cÃ³ token khÃ´ng
  2. Náº¿u cÃ³ â†’ call `/auth/me` Ä‘á»ƒ verify
  3. Náº¿u valid â†’ restore Redux store
  4. Náº¿u invalid â†’ clear táº¥t cáº£

### 2. **Backend: `/auth/me` endpoint** (NEW âœ¨)
- **Route**: `GET /api/auth/me`
- **Middleware**: `authenticateToken` (verify JWT)
- **Controller**: `authController.getCurrentUser()`
- **Service**: `authService.getUserById()`
- **Response**:
```json
{
  "success": true,
  "data": {
    "id": "1",
    "email": "user@example.com",
    "name": "John Doe",
    "avatarUrl": ""
  }
}
```

### 3. **Request Interceptor** (api.ts)
- Tá»± Ä‘á»™ng thÃªm token vÃ o má»i request
- Äá»c tá»« localStorage
- Format: `Authorization: Bearer <token>`

### 4. **Response Interceptor** (api.ts)
- Handle 401 errors
- Tá»± Ä‘á»™ng clear storage
- Optional: redirect to login

## ğŸ“‚ File Structure

```
frontend/src/
â”œâ”€â”€ components/provider/
â”‚   â”œâ”€â”€ AuthInitializer.tsx        â† NEW: Restore auth on reload
â”‚   â””â”€â”€ DictionaryInitializer.tsx  â† Load dict after login
â”œâ”€â”€ features/auth/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useLogin.ts            â† Save token on login
â”‚   â””â”€â”€ api.ts
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ api.ts                     â† Interceptors for token
â””â”€â”€ store/features/auth/
    â””â”€â”€ authSlice.ts               â† Redux state

backend/src/
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ auth.route.ts              â† NEW: /me route
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ auth.controller.ts         â† NEW: getCurrentUser()
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth.service.ts            â† NEW: getUserById()
â””â”€â”€ middlewares/
    â””â”€â”€ auth.middleware.ts         â† authenticateToken
```

## ğŸ¯ TÃ³m táº¯t

### Khi LOGIN:
1. âœ… Token Ä‘Æ°á»£c lÆ°u vÃ o **localStorage + cookie**
2. âœ… User info Ä‘Æ°á»£c lÆ°u vÃ o **Redux store**

### Khi RELOAD:
1. âœ… **AuthInitializer** Ä‘á»c token tá»« localStorage
2. âœ… Call **GET /auth/me** Ä‘á»ƒ verify token
3. âœ… **Restore Redux store** vá»›i user info
4. âœ… Náº¿u token invalid â†’ clear táº¥t cáº£

### Khi Gá»ŒI API:
1. âœ… **Request interceptor** tá»± Ä‘á»™ng thÃªm token
2. âœ… Token Ä‘Æ°á»£c Ä‘á»c tá»« localStorage
3. âœ… Náº¿u 401 â†’ **Response interceptor** clear storage

## ğŸš€ How to use

KhÃ´ng cáº§n lÃ m gÃ¬ cáº£! ğŸ‰

- **AuthInitializer** tá»± Ä‘á»™ng cháº¡y khi app khá»Ÿi Ä‘á»™ng
- **DictionaryInitializer** tá»± Ä‘á»™ng load dict khi authenticated
- Táº¥t cáº£ Ä‘Ã£ Ä‘Æ°á»£c wired up trong layouts

## âš ï¸ Important Notes

1. **Token in 2 places**:
   - `localStorage`: For API calls (axios interceptor)
   - `cookie`: For Next.js middleware (route protection)

2. **Redux is temporary**:
   - Redux state máº¥t khi reload
   - Pháº£i restore tá»« localStorage

3. **Single source of truth**:
   - localStorage = source of truth
   - Redux = derived state

4. **Security**:
   - Token cÃ³ expiry time
   - Backend verify token má»—i request
   - Frontend clear storage khi token invalid
